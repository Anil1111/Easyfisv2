<!DOCTYPE html>
<html>
<head>
    <!-- Meta -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <!-- Title of the Page -->
    <title>Users Detail</title>

    <!-- CSS StyleSheets-->
    @Styles.Render("~/Content/Software-css")
</head>
<body>
    <div id="o-wrapper" class="o-wrapper">
        <!-- Header -->
        @Html.Partial("_SoftwareHeader")

        <!-- Section -->
        <section>
            <div class="sub-nav">
                <div class="container">
                    <div class="row">
                        <div class="col-md-6">
                            <h4><i class="fa fa-user"></i> Users Detail</h4>
                        </div>
                        <div class="col-md-6" align="right">
                            <h5><strong><span id="currentCompanyName"></span> <span> / </span> <span id="currentBranchName"></span></strong></h5>
                        </div>
                    </div>
                </div>
                <div class="div_Current_Page">
                    <div class="container">
                        <a href="@Url.Action("Index", "Software")" class="currentPageLinkCustom">Main Menu</a> > <a href="@Url.Action("Users", "Software")" class="currentPageLinkCustom">Users</a> > Users Detail
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <h4 id=""></h4>
                    </div>
                    <div class="col-md-6" align="right">
                        <button class="btn btn-primary btn-sm" id="btnUserDetailLock" onclick="btnUserDetailLock_OnClick()"><i class="fa fa-lock"></i> Lock</button>
                        <button class="btn btn-primary btn-sm" id="btnUserDetailUnLock" onclick="btnUserDetailUnLock_OnClick()"><i class="fa fa-unlock"></i> Unlock</button>
                        <button class="btn btn-danger btn-sm" id="btnUserDetailClose" onclick="btnUserDetailClose_OnClick()"><i class="fa fa-times"></i> Close</button>
                    </div>
                </div>
                @*<hr />*@
                <div class="well">
                    <form class="form-horizontal" role="form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label col-sm-4">Username:</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control input-sm" id="userDetail_Username" placeholder="Username" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-sm-4">Fullname:</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control input-sm" id="userDetail_Fullname" placeholder="Fullname" />
                                    </div>
                                </div>
                                @*<div class="form-group">
                                        <label class="control-label col-sm-4">Password:</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control input-sm" id="userDetail_Password" />
                                        </div>
                                    </div>*@
                            </div>
                            <div class="col-md-6">
                                @*<div class="form-group">
                                        <label class="control-label col-sm-4">Fullname:</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control input-sm" id="userDetail_Fullname" />
                                        </div>
                                    </div>*@
                                @*<div class="form-group">
                                        <label class="control-label col-sm-4">Copy rights of:</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control input-sm" id="">
                                        </div>
                                    </div>*@
                            </div>
                        </div>
                    </form>
                </div>
                <ul class="nav nav-tabs" role="tablist" id="myTab">
                    <li role="presentation" class="active"><a data-toggle="tab" href="#UserForm" id="journalLedgerTabId">User Form</a></li>
                </ul>
                <br />
                <div class="tab-content">
                    <div id="UserForm" class="tab-pane fade in active">
                        <div class="row">
                            <div class="col-lg-12" align="right">
                                <button class="btn btn-primary btn-sm" id="btnAddUserForm" onclick="cmdAddUserForm_OnClick()"><i class="fa fa-plus"></i> Add</button>
                            </div>
                        </div>
                        <br />
                        <div class="row" align="left">
                            <div class="col-lg-12">
                                <div id="userDetailUserFormGrid" class="grid" align="left"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- User Form Edit Detail -->
        <div class="modal fade" id="userFormEdit" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">User Form Detail</h4>
                    </div>
                    <div class="modal-body">
                        <form>
                            <input type="hidden" id="userForm_Id" />
                            <dl class="dl-horizontal">
                                <dt>Form</dt>
                                <dd>
                                    <div class="comboBox-wide" id="userForm_FormName"></div>
                                </dd>
                                <dt>Add</dt>
                                <dd><input type="checkbox" id="userForm_CanAdd" /></dd>
                                <dt>Edit</dt>
                                <dd><input type="checkbox" id="userForm_CanEdit" /></dd>
                                <dt>Delete</dt>
                                <dd><input type="checkbox" id="userForm_CanDelete" /></dd>
                                <dt>Lock</dt>
                                <dd><input type="checkbox" id="userForm_CanLock" /></dd>
                                <dt>Unlock</dt>
                                <dd><input type="checkbox" id="userForm_CanUnlock" /></dd>
                                <dt>Print</dt>
                                <dd><input type="checkbox" id="userForm_CanPrint" /></dd>
                            </dl>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary btn-sm" id="cmdSaveUserFormButton" onclick="cmdUserFormSaveButton_OnClick()"><i class="fa fa-save"></i> Save</button>
                        <button id="cmdUserFormDetailCloseButton" class="btn btn-danger btn-sm" data-dismiss="modal"><i class="fa fa-close"></i> Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Form Delete Modal Confirmation -->
        <div class="modal fade" id="deleteUserFormConfirm" role="dialog">
            <div class="modal-dialog modal-sm">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Delete Form <i class="fa fa-trash"></i></h4>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this?
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger btn-sm" id="cmdConfirmDeleteUserForm" onclick="cmdUserFormConfirmDeleteButton_OnClick()"><i class="fa fa-trash"></i> Delete</button>
                        <button id="cmdConfirmDeleteUserFormCloseButton" class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-close"></i> Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        @Html.Partial("_SoftwareFooter")
    </div>

    <!-- SideBar Menu -->
    @Html.Partial("_SoftwareSideBarMenu")

    <div id="c-mask" class="c-mask"></div><!-- /c-mask -->
    <!-- Scripts JavaScripts -->
    @Scripts.Render("~/Scripts/Software-js")
    <script type="text/javascript">
        // ================
        // Global Variables
        // ================
        var userForms;
        var userFormGrid;

        var userId = getParam('UserId');
        var IsLocked;

        var cboForForm;
        var formSelectedValue = "";

        // =======================
        // Get URL Parameter Value
        // =======================
        function getParam(name) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regexS = "[\\?&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var results = regex.exec(window.location.href);
            if (results == null) {
                return "";
            } else {
                return results[1];
            }
        }

        // ==============
        // get User By Id
        // ==============
        function getUserByUserId() {
            NProgress.start();
            if (document.location.search.length > 0) {
                $.ajax({
                    url: '/api/listUserById/' + userId,
                    cache: false,
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    data: {},
                    success: function (userResults) {
                        if (userResults != null) {
                            document.getElementById("userDetail_Username").value = userResults.UserName;
                            document.getElementById("userDetail_Fullname").value = userResults.FullName;
                            NProgress.done();
                            if (userResults.IsLocked == true) {
                                document.getElementById("userDetail_Fullname").disabled = true;
                                $("#btnUserDetailLock").prop("disabled", true);
                                $("#btnAddUserForm").prop("disabled", true);
                                IsLocked = true;
                            } else {
                                document.getElementById("userDetail_Fullname").disabled = false;
                                $("#btnUserDetailUnLock").prop("disabled", true);
                                $("#btnAddUserForm").prop("disabled", false);
                                IsLocked = false;
                            }
                        } else {
                            confirm("No Data");
                            window.location = '/Software/Users';
                        }
                    }
                }).fail(function () {
                    confirm("URL Not Found");
                    window.location = '/Software/Users';
                });
            } else {
                NProgress.done();
            }
        }

        // ===================
        // get Form by User Id
        // ===================
        function getUserFormByUserId() {
            var userForms = new wijmo.collections.ObservableArray;
            NProgress.start();
            if (document.location.search.length > 0) {
                $.ajax({
                    url: '/api/listUserFormByUserId/' + userId,
                    cache: false,
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    data: {},
                    success: function (userFormResults) {
                        if (userFormResults.length > 0) {
                            for (i = 0; i < userFormResults.length; i++) {
                                var disable;
                                if (IsLocked == true) {
                                    disable = "disabled";
                                } else {
                                    disable = "";
                                }

                                userForms.push({
                                    EditId: "<button class='btn btn-primary btn-xs btn-block' onclick='cmdUserFormEditButton_OnClick()' " + disable + "><i class='fa fa-edit'></i> Edit</button>",
                                    DeleteId: "<button class='btn btn-danger btn-xs btn-block' onclick='cmdUserFormDeleteButton_OnClick()' " + disable + "><i class='fa fa-trash'></i> Delete</button>",
                                    Id: userFormResults[i]["Id"],
                                    UserId: userFormResults[i]["UserId"],
                                    User: userFormResults[i]["User"],
                                    FormId: userFormResults[i]["FormId"],
                                    Form: userFormResults[i]["Form"],
                                    CanAdd: userFormResults[i]["CanAdd"],
                                    CanEdit: userFormResults[i]["CanEdit"],
                                    CanDelete: userFormResults[i]["CanDelete"],
                                    CanLock: userFormResults[i]["CanLock"],
                                    CanUnlock: userFormResults[i]["CanUnlock"],
                                    CanPrint: userFormResults[i]["CanPrint"]
                                });
                            }
                        }
                        NProgress.done();
                    }
                }).fail(function (xhr, textStatus, err) {
                    alert(err);
                });
            } else {
                confirm("URL Not Found");
                NProgress.done();
                window.location = '/Software/Users';
            }
            return userForms;
        }

        // ===========
        // Lock button
        // ===========
        function btnUserDetailLock_OnClick() {
            $('#btnUserDetailLock').prop('disabled', true);
            $('#btnUserDetailUnLock').prop('disabled', true);
            $('#btnUserDetailClose').prop('disabled', true);

            var userObject = new Object();
            userObject.FullName = document.getElementById('userDetail_Fullname').value;
            userObject.IsLocked = true;
            var data = JSON.stringify(userObject);

            $.ajax({
                type: "PUT",
                url: '/api/updateUser/' + userId,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: data,
                statusCode: {
                    200: function () {
                        $('#btnUserDetailLock').prop('disabled', true);
                        $('#btnUserDetailUnLock').prop('disabled', true);
                        $('#btnUserDetailClose').prop('disabled', true);
                        toastr.success("Locked");
                        window.setTimeout(function () {
                            location.reload();
                        }, 1000);
                    },
                    404: function () {
                        $('#btnUserDetailLock').prop('disabled', true);
                        $('#btnUserDetailUnLock').prop('disabled', false);
                        $('#btnUserDetailClose').prop('disabled', false);
                        toastr.error("Lock request not found");
                    },
                    400: function () {
                        $('#btnUserDetailLock').prop('disabled', false);
                        $('#btnUserDetailUnLock').prop('disabled', true);
                        $('#btnUserDetailClose').prop('disabled', false);
                        toastr.error("Cannot lock record");
                    }
                }
            });
        }

        // =============
        // Unlock button
        // =============
        function btnUserDetailUnLock_OnClick() {
            $('#btnUserDetailLock').prop('disabled', true);
            $('#btnUserDetailUnLock').prop('disabled', true);
            $('#btnUserDetailClose').prop('disabled', true);

            $.ajax({
                type: "PUT",
                url: '/api/unlockUser/' + userId,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: {},
                statusCode: {
                    200: function () {
                        $('#btnUserDetailLock').prop('disabled', true);
                        $('#btnUserDetailUnLock').prop('disabled', true);
                        $('#btnUserDetailClose').prop('disabled', true);
                        toastr.success("Unlocked");
                        window.setTimeout(function () {
                            location.reload();
                        }, 1000);
                    },
                    404: function () {
                        $('#btnUserDetailLock').prop('disabled', true);
                        $('#btnUserDetailUnLock').prop('disabled', false);
                        $('#btnUserDetailClose').prop('disabled', false);
                        toastr.error("Unlock request not found");

                    },
                    400: function () {
                        $('#btnUserDetailLock').prop('disabled', false);
                        $('#btnUserDetailUnLock').prop('disabled', true);
                        $('#btnUserDetailClose').prop('disabled', false);
                        toastr.error("Cannot unlock record");
                    }
                }
            });
        }

        // ============
        // Close button
        // ============
        function btnUserDetailClose_OnClick() {
            window.location = '/Software/Users';
        }

        // ========
        // get Form
        // ========
        function getForm() {
            forms = new wijmo.collections.ObservableArray();
            $.ajax({
                url: '/api/listForm',
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                data: {},
                success: function (formResults) {
                    if (formResults.length > 0) {
                        for (i = 0; i < formResults.length; i++) {
                            forms.push({
                                Id: formResults[i]["Id"],
                                FormName: formResults[i]["FormName"],
                                Particulars: formResults[i]["Particulars"]
                            });
                        }
                        createCboForForm(forms);
                    } else {
                        createCboForForm(forms);
                    }
                }
            });
        }

        // =========================
        // create combo box for form
        // =========================
        function createCboForForm(forms) {
            cboForForm.dispose();
            cboForForm = new wijmo.input.ComboBox('#userForm_FormName', {
                placeholder: "Form Name",
                itemsSource: forms,
                displayMemberPath: "FormName",
                isEditable: false,
                selectedValuePath: "FormName",
                selectedValue: formSelectedValue.toString()
            });
        }

        // ==============
        // Modal Add Form
        // ==============
        function cmdAddUserForm_OnClick() {
            $('#userFormEdit').modal({
                show: true,
                backdrop: 'static'
            });

            $('#cmdSaveUserFormButton').prop('disabled', false);
            $('#cmdUserFormDetailCloseButton').prop('disabled', false);

            document.getElementById('userForm_Id').value = 0
            document.getElementById('userForm_CanAdd').checked = false;
            document.getElementById('userForm_CanEdit').checked = false;
            document.getElementById('userForm_CanDelete').checked = false;
            document.getElementById('userForm_CanLock').checked = false;
            document.getElementById('userForm_CanUnlock').checked = false;
            document.getElementById('userForm_CanPrint').checked = false;

            formSelectedValue = "";
            getForm();
        }

        // ===============
        // Modal Edit Form
        // ===============
        function cmdUserFormEditButton_OnClick() {
            $('#userFormEdit').modal({
                show: true,
                backdrop: 'static'
            });

            $('#cmdSaveUserFormButton').prop('disabled', false);
            $('#cmdUserFormDetailCloseButton').prop('disabled', false);

            userForms.editItem(userForms.currentItem);
            var userForm = userForms.currentEditItem;
            formSelectedValue = userForm.Form;
            document.getElementById('userForm_Id').value = userForm.Id;
            document.getElementById('userForm_CanAdd').checked = userForm.CanAdd;
            document.getElementById('userForm_CanEdit').checked = userForm.CanEdit;
            document.getElementById('userForm_CanDelete').checked = userForm.CanDelete;
            document.getElementById('userForm_CanLock').checked = userForm.CanLock;
            document.getElementById('userForm_CanUnlock').checked = userForm.CanUnlock;
            document.getElementById('userForm_CanPrint').checked = userForm.CanPrint;

            getForm();
        }

        // ====================
        // Save UserForm button
        // ====================
        function cmdUserFormSaveButton_OnClick() {
            $('#cmdSaveUserFormButton').prop('disabled', true);
            $('#cmdUserFormDetailCloseButton').prop('disabled', true);

            var userFormId = document.getElementById('userForm_Id').value;
            var userFormObject = new Object();
            userFormObject.UserId = userId;
            userFormObject.FormId = cboForForm.selectedItem["Id"];
            userFormObject.CanAdd = document.getElementById('userForm_CanAdd').checked;
            userFormObject.CanEdit = document.getElementById('userForm_CanEdit').checked;
            userFormObject.CanDelete = document.getElementById('userForm_CanDelete').checked;
            userFormObject.CanLock = document.getElementById('userForm_CanLock').checked;
            userFormObject.CanUnlock = document.getElementById('userForm_CanUnlock').checked;
            userFormObject.CanPrint = document.getElementById('userForm_CanPrint').checked;
            var data = JSON.stringify(userFormObject);

            if (userFormId == 0) {
                $.ajax({
                    type: "POST",
                    url: '/api/addUserForm',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: data,
                    statusCode: {
                        200: function () {
                            $('#cmdSaveUserFormButton').prop('disabled', true);
                            $('#cmdUserFormDetailCloseButton').prop('disabled', true);
                            toastr.success("Successfully Saved");
                            $('#userFormEdit').modal('hide');
                            refreshUserFormGrid();
                        },
                        404: function () {
                            $('#cmdSaveUserFormButton').prop('disabled', false);
                            $('#cmdUserFormDetailCloseButton').prop('disabled', false);
                            toastr.error("Save request not found");
                            $('#userFormEdit').modal('hide');
                            refreshUserFormGrid();
                        },
                        400: function () {
                            $('#cmdSaveUserFormButton').prop('disabled', false);
                            $('#cmdUserFormDetailCloseButton').prop('disabled', false);
                            toastr.error("Cannot save record");
                            $('#userFormEdit').modal('hide');
                            refreshUserFormGrid();
                        }
                    }
                });
            } else {
                $.ajax({
                    type: "PUT",
                    url: '/api/updateUserForm/' + userFormId,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: data,
                    statusCode: {
                        200: function () {
                            $('#cmdSaveUserFormButton').prop('disabled', true);
                            $('#cmdUserFormDetailCloseButton').prop('disabled', true);
                            toastr.success("Successfully Updated");
                            $('#userFormEdit').modal('hide');
                            refreshUserFormGrid();
                        },
                        404: function () {
                            $('#cmdSaveUserFormButton').prop('disabled', false);
                            $('#cmdUserFormDetailCloseButton').prop('disabled', false);
                            toastr.error("Update request not found");
                            $('#userFormEdit').modal('hide');
                            refreshUserFormGrid();
                        },
                        400: function () {
                            $('#cmdSaveUserFormButton').prop('disabled', false);
                            $('#cmdUserFormDetailCloseButton').prop('disabled', false);
                            toastr.error("Cannot update record");
                            $('#userFormEdit').modal('hide');
                            refreshUserFormGrid();
                        }
                    }
                });
            }
        }
        
        // ==========================
        // Refresh UserForm Flex Grid
        // ==========================
        function refreshUserFormGrid() {
            userForms = new wijmo.collections.CollectionView(getUserFormByUserId());

            userFormGrid.itemsSource = userForms;
            userFormGrid.trackChanges = true;
        }

        // ==============================
        // Modal Delete Form Confirmation
        // ==============================
        function cmdUserFormDeleteButton_OnClick() {
            $('#deleteUserFormConfirm').modal({
                show: true,
                backdrop: 'static'
            });

            $('#cmdConfirmDeleteUserForm').prop('disabled', false);
            $('#cmdConfirmDeleteUserFormCloseButton').prop('disabled', false);
        }
        // delete Form
        function cmdUserFormConfirmDeleteButton_OnClick() {
            userForms.editItem(userForms.currentItem);

            var userForm = userForms.currentEditItem;
            var userFormId = userForm.Id;
            $.ajax({
                type: "DELETE",
                url: '/api/deleteUserForm/' + userFormId,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: {},
                statusCode: {
                    200: function () {
                        $('#cmdConfirmDeleteUserForm').prop('disabled', true);
                        $('#cmdConfirmDeleteUserFormCloseButton').prop('disabled', true);
                        toastr.success("Successfully Deleted");
                        $('#deleteUserFormConfirm').modal('hide');
                        refreshUserFormGrid();
                    },
                    404: function () {
                        $('#cmdConfirmDeleteUserForm').prop('disabled', false);
                        $('#cmdConfirmDeleteUserFormCloseButton').prop('disabled', false);
                        toastr.error("Delete request not found");
                        $('#deleteUserFormConfirm').modal('hide');
                        refreshUserFormGrid();
                    },
                    400: function () {
                        $('#cmdConfirmDeleteUserForm').prop('disabled', false);
                        $('#cmdConfirmDeleteUserFormCloseButton').prop('disabled', false);
                        toastr.error("Cannot delete record");
                        $('#deleteUserFormConfirm').modal('hide');
                        refreshUserFormGrid();
                    }
                }
            });
        }

        // ============
        // On Load Page
        // ============
        $(document).ready(function () {
            getUserByUserId();
            cboForForm = new wijmo.input.ComboBox('#userForm_FormName');

            document.getElementById("userDetail_Username").disabled = true;
            userForms = new wijmo.collections.CollectionView(getUserFormByUserId());
            // Flex Grid for Contact Information
            userFormGrid = new wijmo.grid.FlexGrid('#userDetailUserFormGrid');
            userFormGrid.initialize({
                columns: [
                            {
                                "header": "Edit",
                                "binding": "EditId",
                                "width": 70,
                                "align": "center",
                                "allowResizing": false,
                                "allowSorting": false,
                                "isContentHtml": true
                            },
                            {
                                "header": "Delete",
                                "binding": "DeleteId",
                                "width": 70,
                                "align": "center",
                                "allowResizing": false,
                                "allowSorting": false,
                                "isContentHtml": true
                            },
                            {
                                "header": "Form",
                                "binding": "Form",
                                "width": "3*",
                                "allowResizing": false,
                                "allowSorting": false,
                                "isContentHtml": true
                            },
                            {
                                "header": "Add",
                                "binding": "CanAdd",
                                "allowSorting": true,
                                "width": 80,
                            },
                            {
                                "header": "Edit",
                                "binding": "CanEdit",
                                "allowSorting": true,
                                "width": 80,
                            },
                            {
                                "header": "Delete",
                                "binding": "CanDelete",
                                "allowSorting": true,
                                "width": 80,
                            },
                            {
                                "header": "Lock",
                                "binding": "CanLock",
                                "allowSorting": true,
                                "width": 80,
                            },
                            {
                                "header": "Unlock",
                                "binding": "CanUnlock",
                                "allowSorting": true,
                                "width": 80,
                            },
                            {
                                "header": "Print",
                                "binding": "CanPrint",
                                "allowSorting": true,
                                "width": 80,
                            }
                ],
                autoGenerateColumns: false,
                itemsSource: userForms,
                isReadOnly: true,
                autoSizeMode: wijmo.grid.AutoSizeMode.Both,
                allowDragging: wijmo.grid.AllowDragging.None,
                selectionMode: wijmo.grid.SelectionMode.Row
            });
            userFormGrid.trackChanges = true;
        });

    </script>
</body>
</html>